# Golang单元测试



## 1.go test

#### 自动生成test代码

1.下载gotests包

https://github.com/cweill/gotests

2.执行生成命令

````
gotests -all -w -i 文件名.go
````



#### 执行单元测试

执行命令

````
go test
````

可选参数：

1. -bench regexp 执行相应的 benchmarks，例如 -bench=.；
2. -cover 开启测试覆盖率；
3. -run regexp 只运行 regexp 匹配的函数，例如 -run=Array 那么就执行包含有 Array 开头的函数；
4. -v 显示测试的详细命令；



示例代码 calculation.go：

```Golang
package service

func Add(a, b int) int {
	return a + b
}

func Sub(a, b int) int {
	return a - b
}

func Mul(a, b int) int {
	return a * b
}

func Div(a, b int) int {
	if b == 0 {
		return 0
	}
	return a / b
}
```

示例代码 calculation_test.go：

```Golang
package service

import "testing"

func TestAdd(t *testing.T) {
	type args struct {
		a int
		b int
	}
	tests := []struct {
		name string
		args args
		want int
	}{
		{name: "TestAdd1", args: args{a: 1, b: 2}, want: 3},
		{name: "TestAdd2", args: args{a: 10, b: 2}, want: 12},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := Add(tt.args.a, tt.args.b); got != tt.want {
				t.Errorf("Add(%v, %v) = %v, want %v", tt.args.a, tt.args.b, got, tt.want)
			}
		})
	}
}

func TestSub(t *testing.T) {
	type args struct {
		a int
		b int
	}
	tests := []struct {
		name string
		args args
		want int
	}{
		{name: "TestSub1", args: args{a: 1, b: 2}, want: -1},
		{name: "TestSub2", args: args{a: 10, b: 2}, want: 8},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := Sub(tt.args.a, tt.args.b); got != tt.want {
				t.Errorf("Sub(%v, %v) = %v, want %v", tt.args.a, tt.args.b, got, tt.want)
			}
		})
	}
}

func TestMul(t *testing.T) {
	type args struct {
		a int
		b int
	}
	tests := []struct {
		name string
		args args
		want int
	}{
		{name: "TestMul1", args: args{a: 1, b: 2}, want: 2},
		{name: "TestMul2", args: args{a: 10, b: 2}, want: 20},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := Mul(tt.args.a, tt.args.b); got != tt.want {
				t.Errorf("Mul(%v, %v) = %v, want %v", tt.args.a, tt.args.b, got, tt.want)
			}
		})
	}
}

func TestDiv(t *testing.T) {
	type args struct {
		a int
		b int
	}
	tests := []struct {
		name string
		args args
		want int
	}{
		{name: "TestMul1", args: args{a: 4, b: 2}, want: 2},
		{name: "TestMul2", args: args{a: 10, b: 2}, want: 5},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := Div(tt.args.a, tt.args.b); got != tt.want {
				t.Errorf("Div(%v, %v) = %v, want %v", tt.args.a, tt.args.b, got, tt.want)
			}
		})
	}
}
```

执行命令：

```
go test -v -cover
```

输出结果：

```
=== RUN   TestAdd
=== RUN   TestAdd/TestAdd1
=== RUN   TestAdd/TestAdd2
--- PASS: TestAdd (0.00s)
    --- PASS: TestAdd/TestAdd1 (0.00s)
    --- PASS: TestAdd/TestAdd2 (0.00s)
=== RUN   TestSub
=== RUN   TestSub/TestSub1
=== RUN   TestSub/TestSub2
--- PASS: TestSub (0.00s)
    --- PASS: TestSub/TestSub1 (0.00s)
    --- PASS: TestSub/TestSub2 (0.00s)
=== RUN   TestMul
=== RUN   TestMul/TestMul1
=== RUN   TestMul/TestMul2
--- PASS: TestMul (0.00s)
    --- PASS: TestMul/TestMul1 (0.00s)
    --- PASS: TestMul/TestMul2 (0.00s)
=== RUN   TestDiv
=== RUN   TestDiv/TestMul1
=== RUN   TestDiv/TestMul2
--- PASS: TestDiv (0.00s)
    --- PASS: TestDiv/TestMul1 (0.00s)
    --- PASS: TestDiv/TestMul2 (0.00s)
PASS
coverage: 83.3% of statements
ok      demos/service   0.508s
```



## 2.接口Mock

使用框架：

```
gopkg.in/h2non/gock.v1
```



示例代码：

```Golang
package service

import (
	"fmt"
	"github.com/stretchr/testify/assert"
	"gopkg.in/h2non/gock.v1"
	"io/ioutil"
	"net/http"
	"os"
	"testing"
	"time"
)

var mod = "dev"

func init() {
	switch os.Getenv("KAE_MOD") {
	case "prod":
		mod = "prod"
	}
}

func TestMetaInfo(t *testing.T) {
	if mod != "prod" {
		// 最后需要释放gock，最大限度地减少测试代码中的潜在副作用
		defer gock.Off()

		// 注册gock，注意只会拦截一次，定义返回结果
		gock.New("https://chuangkit.docer.wps.cn").
			Get("/meta/info").
			Reply(200).
			JSON(map[string]string{"name": "test"})
	}
	for i := 0; i < 10; i++ {
		res, err := http.Get("https://chuangkit.docer.wps.cn/meta/info")
		assert.ErrorIs(t, err, nil)

		bytes, err := ioutil.ReadAll(res.Body)
		assert.ErrorIs(t, err, nil)

		fmt.Println(string(bytes))
		res.Body.Close()

		time.Sleep(1 * time.Second)
	}
}
```



## 3.数据库Mock

使用框架：

```
github.com/DATA-DOG/go-sqlmock
```



1.查询Mock

```Golang
import (
	"demos/db/global"
	"fmt"
	"github.com/DATA-DOG/go-sqlmock"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestQuery(t *testing.T) {
	db, err := global.GenerateDB()
	assert.ErrorIs(t, err, nil)

	// 创建数据库记录
	rows := sqlmock.NewRows([]string{"id", "name"}).
		AddRow(1, "张三").
		AddRow(2, "李四").
		AddRow(3, "Bob")
	studentId := 1
	// 定义查询Mock
	global.MockExpectQuery("SELECT id,name FROM `t_student` WHERE id=\\? AND name=\\? LIMIT 1",
		rows, studentId, "张三")
	
	// 执行查询语句
	var student Student
	err = db.Model(&Student{}).Select("id,name").Where("id=? AND name=?", studentId, "张三").Take(&student).Error
	assert.ErrorIs(t, err, nil)

	fmt.Println(student)
	if err := global.ExpectationsWereMet(); err != nil {
		t.Fatalf("there were unfulfilled expectations: %s", err)
	}

	global.MockExpectQuery("SELECT id,name FROM `t_student`", rows)
	var list []Student
	err = db.Model(&Student{}).Select("id,name").Find(&list).Error
	assert.ErrorIs(t, err, nil)
	fmt.Println(list)
	if err := global.ExpectationsWereMet(); err != nil {
		t.Fatalf("there were unfulfilled expectations: %s", err)
	}
}
```



2.修改Mock

```Golang
import (
	"demos/db/global"
	"github.com/DATA-DOG/go-sqlmock"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestCreate(t *testing.T) {
	db, err := global.GenerateDB()
	assert.ErrorIs(t, err, nil)

    // 定义修改Mock
	global.MockExpectOnceWithTx("INSERT INTO `t_student`",
		sqlmock.NewResult(1, 1),
		"张三", 20, "", 1)

	s := Student{
		Id:      1,
		Name:    "张三",
		Age:     20,
		HeadImg: "",
	}
    // 执行修改语句
	err = db.Create(&s).Error
	assert.ErrorIs(t, err, nil)

    // 判断结果集
	if err := global.ExpectationsWereMet(); err != nil {
		t.Fatalf("there were unfulfilled expectations: %s", err)
	}
}
```

